<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard do Consultor - FinAPP</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/consultor.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="sidebar">
    <div class="logo">
      <a href="{{ url_for('home') }}">
        <header><img src="{{ url_for('static', filename='css/logo.png') }}" alt=""></header>
      </a>
    </div> 
    <ul>
      <li data-section="dashboard" class="active">Dashboard</li>
      <li data-section="clientes">Clientes</li>
      <li data-section="relatorios">Relatórios</li>
      <div class="user-info">
        <i class="fas fa-bell notification-icon"></i>
        <a href="{{ url_for('index') }}" id="btn-sair" class="btn-sair">
          <i class="fas fa-sign-out-alt"></i> Sair
        </a>
        <div class="user-avatar"></div>
      </div>
    </ul>
</div>

<div class="main-content">
    <header>
      <h1>Visão Geral</h1>
      <div class="user-info">
        <p>Bem-vindo, <strong>{{ user_nome }}!</strong></p>
      </div>
    </header>

    <!-- === DASHBOARD === -->
    <section class="cards" id="dashboard"> 
      <div class="card">
        <h3>Total de Clientes</h3>
        <p id="clientes-total">{{ total_clientes }}</p>
      </div>

      <div class="card">
        <h3>Receita Total</h3>
        <p id="receita-total">R$ {{ receita_total }}</p>
      </div>

      <div class="card">
        <h3>Gastos Totais</h3> 
        <p id="gastos-total">R$ {{ gastos_total }}</p>
      </div>

      <div class="charts">
        <div class="chart-container">
          <h3>Receitas x Gastos</h3>
          <canvas id="graficoPizza"></canvas>
        </div>

        <div class="chart-container">
          <h3>Comparativo Financeiro</h3>
          <canvas id="graficoBarras"></canvas>
        </div>
      </div>
    </section>

    <!-- === CLIENTES === -->
    <section class="clientes-section" id="clientes" style="display:none;">
      <h2>Histórico de Clientes</h2>
      <table>
        <thead>
          <tr>
            <th>Nome</th>
            <th>Salário</th>
            <th>Despesa</th>
            <th>Saldo</th>
            <th>Metas</th>
          </tr>
        </thead>
        <tbody id="clientes-lista">
            {% for c in clientes %}
            <tr>
              <td>{{ c[1] }}</td> <!-- nome -->
              <td>R$ {{ c[2]|float|round(2) }}</td> <!-- renda -->
              <td>R$ {{ c[3]|float|round(2) }}</td> <!-- gastos -->
              <td class="{{ 'positivo' if c[4]|float >= 0 else 'negativo' }}">R$ {{ c[4]|float|round(2) }}</td> <!-- saldo -->
              <td><!-- metas do cliente aqui --></td>
            </tr>
            {% endfor %}
          </tbody>
      </table>
    </section>

    <!-- === RELATÓRIOS === -->
    <section class="relatorios-section" id="relatorios" style="display:none;">
      <div class="card">
        <h3>Relatório</h3>
        <p>Visualize os resultados financeiros.</p>
        <a href="{{ url_for('download_clientes') }}" class="btn">Baixar Dados dos Clientes</a>
      </div>
    </section>

</div>

  <script>
    // ==== Navegação ====
    const sidebarItems = document.querySelectorAll('.sidebar ul li');
    const sections = {
      dashboard: document.getElementById('dashboard'),
      clientes: document.getElementById('clientes'),
      relatorios: document.getElementById('relatorios'),
    };

    function mostrarSecao(sec) {
      Object.values(sections).forEach(s => s.style.display = 'none');
      sections[sec].style.display = 'block';
    }

    sidebarItems.forEach(item => {
      item.addEventListener('click', () => {
        sidebarItems.forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        mostrarSecao(item.dataset.section);
      });
    });

    mostrarSecao('dashboard');

    // ==== GRÁFICOS DASHBOARD (estilizados) ====
  const receitaTotal = parseFloat('{{ receita_total|default(0) }}') || 0;
  const gastosTotal = parseFloat('{{ gastos_total|default(0) }}') || 0;

  // ===== GRÁFICO DE PIZZA =====
  const ctxPizza = document.getElementById('graficoPizza');
  if (ctxPizza) {
    new Chart(ctxPizza, {
      type: 'doughnut',
      data: {
        labels: ['Receitas', 'Gastos'],
        datasets: [{
          data: [receitaTotal, gastosTotal],
          backgroundColor: ['#6c2bb6', '#e74c3c'],
          borderWidth: 2,
          borderColor: '#fff',
          hoverOffset: 10
        }]
      },
      options: {
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              color: '#333',
              font: { size: 14, weight: '500' }
            }
          },
          title: {
            display: false
          },
          tooltip: {
            backgroundColor: '#6c2bb6',
            titleFont: { weight: 'bold' },
            bodyFont: { size: 13 },
            callbacks: {
              label: (context) => 
                `${context.label}: R$ ${context.parsed.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`
            }
          }
        },
        cutout: '70%'
      }
    });
  }

  // ===== GRÁFICO DE BARRAS =====
  const ctxBarras = document.getElementById('graficoBarras');
  if (ctxBarras) {
    new Chart(ctxBarras, {
      type: 'bar',
      data: {
        labels: ['Receita Total', 'Gastos Totais'],
        datasets: [{
          label: 'Valores (R$)',
          data: [receitaTotal, gastosTotal],
          backgroundColor: ['#6c2bb6', '#e74c3c'],
          borderRadius: 8,
          barThickness: 60
        }]
      },
      options: {
        scales: {
          x: {
            ticks: { color: '#333', font: { size: 13 } },
            grid: { display: false }
          },
          y: {
            beginAtZero: true,
            ticks: { color: '#333', font: { size: 12 } },
            grid: { color: 'rgba(0,0,0,0.05)' }
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: '#9b59b6',
            callbacks: {
              label: (context) =>
                `R$ ${context.parsed.y.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`
            }
          }
        }
      }
    });
  }

  </script>
</body>
</html>
